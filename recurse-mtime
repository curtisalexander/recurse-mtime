#!/usr/bin/env node

/**
 * Dependencies
 */

var fs = require('fs');
var path = require('path');

/**
 * Options
 */

startDir = process.argv[2];

/**
 * Define functions
 */

// recursive search a la *nix find

function find(startDir, cb) {
  var uniqueYears = [];
  var uniqueMonths = [];
  var uniqueYYMMs = [];
  var uniqueYYMMsObj = [];
  var fileCnt = 1;
  var asyncRunning = 0;

  function dirOrFile (dirFile) {
    // async function
    fs.stat(dirFile, function(err, stats) {
      if (err) throw err;
      // if directory, call find again on all files within the directory
      if (stats.isDirectory()) {
        fileCnt--;
        asyncRunning++;
        // another async function
        fs.readdir(dirFile, function(err, files) {
          asyncRunning--;
          if (err) throw err;
          fileCnt += files.length;
          for(var i = 0; i < files.length; i++) {
            dirOrFile(path.join(dirFile, files[i])); // recurse
          }
        });
      } else if (stats.isFile()) {
        fileCnt--;
        year = stats['mtime'].getFullYear().toString();
        month = ('0' + (stats['mtime'].getMonth()+1)).slice(-2);
        yymm = year + '-' + month;

        console.log('file: ' + dirFile);
        console.log('year: ' + year); 
        console.log('month: ' + month);
        console.log();

        // if value of year does not exist for the key 'year'
        if (!(uniqueYYMMsObj.some(function(uniqueYYMMsObj) { return hasValue(uniqueYYMMsObj, 'year', year); }))) {
          uniqueYYMMsObj.push({'year': year, 'months': [month]});   
        } else {
          var yearIndex = -1;
          for (var j = 0; j < uniqueYYMMsObj.length; j++) {
            if (uniqueYYMMsObj[j]['year'] === year) {
              yearIndex = j;
              break;
            }
          }
          if (yearIndex !== -1) {
           // uniqueYYMMsObj[yearIndex]['months'].push(month);
            var monthIndex = -1;
            for (var k = 0; k < uniqueYYMMsObj[yearIndex]['months'].length; k++) {
              if (uniqueYYMMsObj[yearIndex]['months'][k] === month) {
                monthIndex = k;
                break;
              }
            }
            if (monthIndex === -1) {
              uniqueYYMMsObj[yearIndex]['months'].push(month);
            }
          }
        }

        if (uniqueYYMMs.indexOf(yymm) === -1) {
          uniqueYYMMs.push(yymm);
        }
        if (uniqueYears.indexOf(year) === -1) {
          uniqueYears.push(year);
        }
        if (uniqueMonths.indexOf(month) === -1) {
          uniqueMonths.push(month);
        }
      } else {
        fileCnt--;
      }
      if (fileCnt === 0 && asyncRunning === 0) {
        // sort
        uniqueYears.sort();
        uniqueMonths.sort();
        uniqueYYMMs.sort();
        uniqueYYMMsObj.sort();
        for (var l = 0; l < uniqueYYMMsObj.length; l++) {
          uniqueYYMMsObj[l]['months'].sort();
        }
        cb(uniqueYears, uniqueMonths, uniqueYYMMs, uniqueYYMMsObj);
      }
    });
  }
  dirOrFile(startDir);
}

// for array.some method
function hasValue(obj, key, value) {
  return obj.hasOwnProperty(key) && obj[key] === value;
}

function printUniques(arr, label) {
  console.log('Unique ' + label + '...');
  for (var i = 0; i < arr.length; i++) {
    console.log(arr[i]);
  }
  console.log();
}

function uniques(uniqueYears, uniqueMonths, uniqueYYMMs, uniqueYYMMsObj) {
  printUniques(uniqueYears, 'years');
  printUniques(uniqueMonths, 'months');
  printUniques(uniqueYYMMs, 'YYMMs');
  printUniques(uniqueYYMMsObj, 'YYMMs');
}

find(startDir, uniques);
